<html><head><meta charset="UTF-8"/><title>Déployé : corrections dans les calculs de totaux</title><meta name="description"/><link rel="stylesheet" href="/styles/style.css"/><link rel="shortcut icon" type="image/png" href="/favicon.png?v=2"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="twitter:site" content="@ciboulette.net"/><meta name="twitter:title" content="ciboulette.net"/><meta name="twitter:creator" content="@RenanLeCaro"/><meta name="twitter:image" content="https://i.imgur.com/KXzgfoT.png"/><meta property="og:title" content="ciboulette.net"/><meta property="og:type" content="website"/><meta property="og:url" content="https://ciboulette.net/"/><meta property="og:image" content="https://i.imgur.com/KXzgfoT.png"/><meta property="og:description" content="Ciboulette.net est un système de Commande en ligne dédiés aux maraichers en vente directe."/><meta property="og:site_name" content="ciboulette.net"/><meta property="fb:admins" content="1136448477"/></head><body> <div class="blogPost"><div class="content"><h1>Déployé : corrections dans les calculs de totaux</h1><div class="intro">Les changements plus ou moins récents n'était pas tout à fait justes</div><html><body><p>On m&apos;a averti il y a 3 jours de petites diff&eacute;rences de quelques centimes entre le montant des factures/tickets de caisse et les montants affich&eacute;s dans les listes (commandes, paiements ..).</p><p>Il s&apos;av&egrave;re que le calcul du total de facture est fait &agrave; deux endroits diff&eacute;rents dans le code.</p><p>Historiquement (jusqu&apos;en mars 2021) tout les calculs &eacute;taient fait cot&eacute; serveur (en <strong>JavaScript</strong>). Mais c&apos;&eacute;tait un peu lent. Si un prix de produit changeait par exemple, il fallait recalculer les totaux des commandes contenant le produit. Comme c&apos;&eacute;tait lent, j&apos;essayais de le faire le moins souvent possible, avec parfois des bugs ou un total aurait du changer mais restait &agrave; son ancienne valeur.</p><p>En mars, j&apos;ai introduit une nouvelle mani&egrave;re de calculer ces totaux, directement en base de donn&eacute;e (<strong>mongodb</strong>). C&apos;est beaucoup plus rapide (de l&apos;ordre de 50x plus rapide). L&rsquo;inconv&eacute;nient, c&apos;est que la base de donn&eacute;e &agrave; des diff&eacute;rences subtile dans sa mani&egrave;re de faire les arrondis.</p><p>J&apos;ai continu&eacute; d&apos;utiliser les deux m&eacute;thodes en parall&egrave;le, mais le r&eacute;sultat &eacute;tait parfois diff&eacute;rent.</p><p>Cette partie est corrig&eacute;e, j&apos;ai r&eacute;tabli le fonctionnement historique et mongoDB imite maintenant les arrondis fait par JavaScript.</p><p>J&apos;ai voulu v&eacute;rifier que les totaux correspondaient bien pour toutes les commandes enregistr&eacute;es, et c&apos;est la que j&apos;ai d&eacute;couvert plusieurs bugs</p><ul><li>les produits command&eacute;s, puis supprim&eacute;s de la liste de produit par le mara&icirc;cher &eacute;taient &quot;remplac&eacute;s&quot; par le dernier produit de la liste au moment du calcul dans mongodb</li><li>les frais de livraison &eacute;taient ignor&eacute;s compl&egrave;tement dans le total calcul&eacute; par mongdb</li><li>les frais de livraison &eacute;taient appliqu&eacute;s pour une commande vide dans le calcul javascript ..</li><li>les prix comme 0.000000000001 &eacute;taient replac&eacute;s par 0.10&euro; dans le calcul JavaScript</li></ul><p>Bref, pas mal de points &agrave; corriger.</p><p>J&apos;ai fait en sorte de sauvegarder le total existant, appliquer les corrections, et ensuite voir ou est ce qu&apos;il y a une diff&eacute;rence entre les deux.</p><p>Je suis donc en mesure de vous fournir un fichier Excel listant les commandes ayant &quot;boug&eacute;&quot;</p><p>Puisque l&apos;id&eacute;e principale est de retrouver les m&ecirc;me totaux qu&apos;avant mars, vous devriez pouvoir ignorer les changements list&eacute;s pour les semaines d&apos;avant mars 2021.</p><p>Je vais envoyer individuellement le fichier par mail &nbsp;aux 7 mara&icirc;chers touch&eacute;s par le probl&egrave;me</p><p>J&apos;ai aussi livr&eacute; <strong>deux nouvelles petites fonctions</strong> en passant :</p><ul><li>Case a cocher pour afficher les commandes vides dans l&apos;onglet commande, d&eacute;coch&eacute;e par d&eacute;faut</li><li>Autorisation de prix nul pour les produits (entrer 0). Le produit sera affich&eacute; comme &quot;gratuit&quot; et les clients pourront le commander. Le comportement s&apos;il ne commande que des produits gratuits n&apos;est pas encore clair, mais au moins &ccedil;a devrais pouvoir &eacute;viter les hacks du type &quot;0.000000000001 &euro;/kg &quot;</li></ul><p><br/></p><p><br/></p><p><br/></p><p><br/></p></body></html></div><a class="back" href="/blog"><span>Retourner à la liste des billets</span></a></div><nav id="topMenu"><input type="checkbox" id="toggleMenu"/><a class="appName" href="/">Ciboulette.net </a><a href="/tarif.html">Prix</a><a href="/fonctions.html">Fonctions</a><a href="/faq.html">FAQ</a><a href="/blog/">Blog</a><div class="grow"></div><a target="_blank" href="https://app.ciboulette.net">Connexion</a><a class="signUp" target="_blank" href="https://app.ciboulette.net" onClick="plausible('signup')">Inscription</a><label class="toggleMenu" for="toggleMenu">Menu</label></nav><div class="footer"><div class="part gridded"><strong>Coordonnées</strong><div class="k">Nom</div><div class="v">Renan LE CARO</div><div class="k">E-mail</div><div class="v"><a href="mailto:renan.lecaro@gmail.com">renan.lecaro@gmail.com</a></div><div class="k">Teléphone</div><div class="v"><a href="tel:+33628350114">+33 6 28 35 01 14</a></div><div class="k">Adresse </div><div class="v"> La Basse Bouexière n°9<br/>35360 Médréac </div></div><div class="part gridded"><strong>Entreprise </strong><div class="k">Société</div><div class="v"><a target="_blank" href="https://www.societe.com/societe/monsieur-renan-le-caro-515320331.html"> Auto Entreprise <br/>Renan LE CARO </a></div><div class="k">SIRET</div><div class="v">51532033100025 </div><div class="k">TVA</div><div class="v">FR 31 515320331  </div><div class="k">CGU</div><div class="v"><a href="/cgu.html">Conditions générales</a></div></div><div class="part"><strong>Autres liens</strong><div><a target="_blank" href="https://www.facebook.com/ciboulette.net/">Facebook</a>&nbsp;: page officielle</div><div><a target="_blank" href="https://trello.com/b/GaZSJzzq/ciboulettenet-roadmap">Trello</a>&nbsp;: évolutions prévues</div><div> <a target="_blank" href="https://uptime.ciboulette.net/">Statuscake</a>&nbsp;: historique maintenances</div><div><a target="_blank" href="https://fr.trustpilot.com/review/ciboulette.net">Trustpilot</a>&nbsp;: avis clients</div><div><a target="_blank" href="https://plausible.io/ciboulette.net">Plausible</a>&nbsp;: Statistiques de ce site</div></div></div><script src="/scripts.js"></script><script>window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }</script><script async="async" defer="defer" data-domain="ciboulette.net" src="https://stats.ciboulette.net/js/plausible.js"></script></body></html>